name: Deploy NestJS App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: SSH & Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Generate .env file for production
        run: |

      - name: ðŸ“¡ Connect to VPS and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/apps/brado
            echo "âœ… Pulling latest code..."
            git pull

            sudo rm .env
            echo "POSTGRES_PASSWORD=\"${{ secrets.POSTGRES_PASSWORD }}\"" >> .env
            echo "POSTGRES_HOST=${{ secrets.POSTGRES_HOST }}" >> .env
            echo "POSTGRES_PORT=${{ secrets.POSTGRES_PORT }}" >> .env
            echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> .env
            echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env
            echo "PORTNAME=${{ secrets.PORTNAME }}" >> .env
            echo "STARTADDRESS=${{ secrets.STARTADDRESS }}" >> .env
            echo "NUMBER_OF_REGISTERS=${{ secrets.NUMBER_OF_REGISTERS }}" >> .env
            echo "READINGS_ENDPOINT=${{ secrets.READINGS_ENDPOINT }}" >> .env

            sudo docker-compose down --remove-orphans
            sudo docker-compose build 
            sudo docker-compose up -d
